import cv2
import os
import numpy as np
from datetime import datetime

# ---- PATHS ----
BASE_DIR = r"C:/Users/Admin/Desktop/faceproject"
DATASET_DIR = os.path.join(BASE_DIR, "students_faces")
MODEL_PATH = os.path.join(BASE_DIR, "face_model.yml")
LABELS_PATH = os.path.join(BASE_DIR, "labels.npy")
CASCADE_PATH = os.path.join(BASE_DIR, "haarcascade_frontalface_default.xml")

# ---- Load Haarcascade ----
face_cascade = cv2.CascadeClassifier(CASCADE_PATH)
if face_cascade.empty():
    print("Error: Haar cascade file not loaded! ❌")
    exit()
else:
    print("Haar cascade loaded successfully ✅")

# ---- Load recognizer ----
def load_recognizer():
    if not os.path.exists(MODEL_PATH):
        return None, {}
    recognizer = cv2.face.LBPHFaceRecognizer_create()
    recognizer.read(MODEL_PATH)
    label_map = np.load(LABELS_PATH, allow_pickle=True).item()
    return recognizer, label_map

# ---- Train model ----
def train_model():
    recognizer = cv2.face.LBPHFaceRecognizer_create()
    faces, labels = [], []
    label_map = {}
    current_label = 0

    for student in os.listdir(DATASET_DIR):
        student_path = os.path.join(DATASET_DIR, student)
        if not os.path.isdir(student_path):
            continue
        label_map[current_label] = student
        for img_name in os.listdir(student_path):
            img_path = os.path.join(student_path, img_name)
            img = cv2.imread(img_path, cv2.IMREAD_GRAYSCALE)
            if img is None:
                continue
            faces.append(img)
            labels.append(current_label)
        current_label += 1

    if len(faces) == 0:
        print("No faces to train. ⚠")
        return

    recognizer.train(faces, np.array(labels))
    recognizer.write(MODEL_PATH)
    np.save(LABELS_PATH, label_map)
    print("Model trained successfully! ✅")

# ---- Save face for student ----
def save_face(gray_frame, face, student_name):
    (x, y, w, h) = face
    student_folder = os.path.join(DATASET_DIR, student_name)
    os.makedirs(student_folder, exist_ok=True)

    face_crop = gray_frame[y:y+h, x:x+w]
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    img_path = os.path.join(student_folder, f"{student_name}_{timestamp}.jpg")
    cv2.imwrite(img_path, face_crop)
    print(f"Saved face: {img_path} ✅")

# ---- Camera loop ----
def start_camera():
    cam = cv2.VideoCapture(0)
    cam.set(3, 640)
    cam.set(4, 480)
    print("Camera started. Press 'q' to quit.")

    recognizer, label_map = load_recognizer()
    saved_faces = set()  # to track which student has been saved in this session

    while True:
        ret, frame = cam.read()
        if not ret:
            print("Failed to capture camera frame ❌")
            break

        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        faces = face_cascade.detectMultiScale(gray, scaleFactor=1.05, minNeighbors=4, minSize=(60,60))

        for (x, y, w, h) in faces:
            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 255, 0), 2)

            recognized_name = None
            if recognizer is not None:
                face_roi = gray[y:y+h, x:x+w]
                try:
                    label, confidence = recognizer.predict(face_roi)
                    if confidence < 70:
                        recognized_name = label_map[label]
                        cv2.putText(frame, recognized_name, (x, y-10),
                                    cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 255, 0), 2)
                    else:
                        cv2.putText(frame, "Unknown", (x, y-10),
                                    cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 0, 255), 2)
                except:
                    cv2.putText(frame, "Unknown", (x, y-10),
                                cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 0, 255), 2)

            # ---- SAVE FACE ONLY ONCE PER SESSION ----
            # key = recognized_name if existing student else new student input
            key_name = recognized_name
            if recognized_name is None:
                # Ask name for new student if not already saved
                name_input = input("Enter new student's name: ").strip()
                if name_input:
                    key_name = name_input
                    train_model()  # retrain after adding new student
                    recognizer, label_map = load_recognizer()

            if key_name and key_name not in saved_faces:
                save_face(gray, (x, y, w, h), key_name)
                saved_faces.add(key_name)  # mark as saved

        cv2.imshow("Face Recognition", frame)
        key = cv2.waitKey(1) & 0xFF
        if key == ord('q'):
            break

    cam.release()
    cv2.destroyAllWindows()

# ---- MAIN ----
if __name__ == "__main__":
    os.makedirs(DATASET_DIR, exist_ok=True)
    start_camera()

